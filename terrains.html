<!DOCTYPE html>
<!--
  Page Terrains (réservations)
  Rôle: permettre de réserver un terrain en choisissant la date, le terrain, l'heure de début et la durée.
  Stockage: les réservations sont enregistrées dans localStorage (démonstration hors-ligne).
  Conflits: la logique JS empêche de réserver un créneau déjà pris sur un même terrain.
-->
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Terrains – Tennis Club de Rambouillet</title>
  <link href="https://fonts.googleapis.com/css?family=Barlow+Semi+Condensed:600,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* Styles locaux pour le formulaire de réservation et la liste */
    .booking { background:#FFF8E9; padding: 30px 0 30px 0; }
    .booking .form { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; justify-content:center; margin: 10px 0 12px 0; }
    .booking label { display:flex; flex-direction:column; font-size:.95rem; }
    .booking input, .booking select { padding:10px 12px; border:1px solid #e7dcc9; border-radius:10px; background:white; min-width: 160px; }
    .booking .btn-row { display:flex; gap:12px; }
    .btn { display:inline-block; background:#F95E2D; color:#FFF8E9; font-weight:bold; padding:12px 22px; border-radius:30px; border:2px solid transparent; text-decoration:none; cursor:pointer; transition:.2s; }
    .btn:hover { background:#FFF8E9; color:#F95E2D; border-color:#F95E2D; transform:scale(1.03); }
    .booking .grid { margin-top: 16px; }
    .notice { text-align:center; font-size:.95rem; color:#555; margin-top:12px; }
    .list { margin-top:20px; }
    .res-item { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 16px; background:white; border:1px solid #e7dcc9; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
    .res-col { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .badge { background:#202226; color:#FFF8E9; padding:6px 10px; border-radius:20px; font-size:.9rem; }
    .muted { color:#666; font-size:.95rem; }
    .empty { text-align:center; color:#666; padding:10px 0; }
  </style>
</head>
<body>
  <header>
    <div class="container header-flex">
      <a href="index.html">
        <img src="img/logo.png" alt="Logo Tennis Club de Rambouillet" class="logo">
      </a>
      <nav>
        <ul>
          <li><a href="index.html">Accueil</a></li>
          <li><a href="le-club.html">Le Club</a></li>
          <li><a href="inscriptions.html">Inscriptions</a></li>
          <li><a href="terrains.html" class="active" aria-current="page">Terrains</a></li>
          <li><a href="/tennis-club-rambouillet/php/medias.php">Médias</a></li>
          <li><a href="boutique.html">Boutique</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="php/login.php">Mon espace</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Réserver un terrain</h1>
      <p>Choisissez une date, un terrain et un créneau pour jouer.</p>
    </div>
  </section>

  <!-- Contenu principal: formulaire et liste de réservations -->
  <main class="booking">
    <div class="container">
      <h2 style="text-align:center; margin-bottom:12px;">Nouvelle réservation</h2>
      <form class="form" id="booking-form" autocomplete="off">
        <label>
          Date
          <input type="date" id="bk-date" required>
        </label>
        <label>
          Terrain
          <select id="bk-court" required>
            <option value="Extérieur 1">Extérieur 1</option>
            <option value="Extérieur 2">Extérieur 2</option>
            <option value="Padel">Padel</option>
            <option value="Salle 1">Salle 1</option>
            <option value="Salle 2">Salle 2</option>
            <option value="Salle 3">Salle 3</option>
          </select>
        </label>
        <label>
          Début
          <select id="bk-start" required></select>
        </label>
        <label>
          Durée
          <select id="bk-duration" required>
            <option value="60">1 h</option>
            <option value="90">1 h 30</option>
            <option value="120">2 h</option>
          </select>
        </label>
        <div class="btn-row">
          <button type="submit" class="btn">Réserver</button>
          <button type="button" id="btn-clear-day" class="btn" title="Effacer mes réservations du jour">Effacer la journée</button>
        </div>
      </form>

      <p class="notice">Démonstration hors-ligne: les réservations sont stockées dans votre navigateur.</p>

      <section class="list" aria-label="Mes réservations">
        <h2 style="text-align:center; margin-bottom:12px;">Mes réservations</h2>
        <div id="res-list"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Tennis Club de Rambouillet — Tous droits réservés</p>
    </div>
  </footer>

  <script>
    // === Réservations (localStorage) ===
    // Données: tableau d'objets {date, court, start, end}
    // Fonctions:
    //  - load/save: lecture/écriture localStorage
    //  - formatHM/toMinutes: utilitaires pour heures/minutes
    //  - populateStartSelect: remplit les heures de début (08:00 à 21:00)
    //  - overlap: teste chevauchement de deux créneaux
    //  - renderList: affiche les réservations triées
    //  - addReservation: ajoute si pas de conflit et pas au-delà de la fermeture
    const KEY = 'tcr_bookings_v1';
    const OPEN_HOUR = 8;  // 08:00
    const CLOSE_HOUR = 22; // 22:00

    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch(_){ return []; } }
    function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

    function formatHM(h, m=0){
      return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }

    function toMinutes(hhmm){
      const [h,m] = hhmm.split(':').map(Number);
      return h*60+m;
    }

    function todayStr(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Remplit la liste des heures de début (de OPEN_HOUR à CLOSE_HOUR-1)
    function populateStartSelect(){
      const sel = document.getElementById('bk-start');
      sel.innerHTML = '';
      for(let h=OPEN_HOUR; h<=CLOSE_HOUR-1; h++){
        const t = formatHM(h,0);
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t; sel.appendChild(opt);
      }
    }

    // Détecte le chevauchement entre deux créneaux [aStart,aEnd[ et [bStart,bEnd[
    function overlap(aStart, aEnd, bStart, bEnd){
      return Math.max(aStart, bStart) < Math.min(aEnd, bEnd);
    }

    // Affiche la liste des réservations en les triant (date, terrain, heure)
    function renderList(){
      const list = document.getElementById('res-list');
      const data = load();
      if(data.length === 0){ list.innerHTML = `<p class="empty">Aucune réservation enregistrée.</p>`; return; }
      list.innerHTML = data
        .sort((a,b)=> a.date.localeCompare(b.date) || a.court.localeCompare(b.court) || a.start.localeCompare(b.start))
        .map((r,idx)=>{
          return `
          <div class="res-item" data-idx="${idx}">
            <div class="res-col">
              <span class="badge">${r.court}</span>
              <span class="muted">${r.date}</span>
              <span>${r.start} – ${r.end}</span>
            </div>
            <div class="res-col">
              <button class="btn btn-cancel" data-idx="${idx}">Annuler</button>
            </div>
          </div>`;
        }).join('');
    }

    // Ajoute une réservation si elle ne dépasse pas l'heure de fermeture et sans conflit
    function addReservation(date, court, start, durationMin){
      const startMin = toMinutes(start);
      const endMin = startMin + Number(durationMin);
      const end = formatHM(Math.floor(endMin/60), endMin%60);
      // bornes ouverture
      if(endMin > CLOSE_HOUR*60){
        alert('Le créneau dépasse l\'heure de fermeture.');
        return false;
      }
      const data = load();
      const conflicts = data.filter(r => r.date===date && r.court===court && overlap(toMinutes(r.start), toMinutes(r.end), startMin, endMin));
      if(conflicts.length){
        alert('Conflit: le terrain est déjà réservé sur ce créneau.');
        return false;
      }
      data.push({date, court, start, end});
      save(data); renderList();
      alert('Réservation enregistrée.');
      return true;
    }

    // Initialisation: remplit les heures, fixe la date sur aujourd'hui, rend la liste, puis attache les événements
    document.addEventListener('DOMContentLoaded', ()=>{
      // init
      populateStartSelect();
      const inputDate = document.getElementById('bk-date');
      inputDate.value = todayStr();
      renderList();

      // Soumission du formulaire de création de réservation
      document.getElementById('booking-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const date = document.getElementById('bk-date').value;
        const court = document.getElementById('bk-court').value;
        const start = document.getElementById('bk-start').value;
        const duration = document.getElementById('bk-duration').value;
        addReservation(date, court, start, duration);
      });

      // Click sur Annuler: supprime une réservation à l'index donné
      document.getElementById('res-list').addEventListener('click', (e)=>{
        const btn = e.target.closest('.btn-cancel');
        if(!btn) return;
        const idx = Number(btn.dataset.idx);
        const data = load();
        data.splice(idx,1); save(data); renderList();
      });

      // Effacer la journée: supprime toutes les réservations du jour sélectionné
      document.getElementById('btn-clear-day').addEventListener('click', ()=>{
        const date = document.getElementById('bk-date').value;
        const data = load().filter(r => r.date !== date);
        save(data); renderList();
      });
    });
  </script>
  <script src="js/nav-badge.js"></script>
</body>
</html>
